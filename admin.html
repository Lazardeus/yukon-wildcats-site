<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Yukon Wildcats Contracting</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-login {
            max-width: 400px;
            margin: 50px auto;
        }
        
        .admin-panel {
            display: none;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 10px 20px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
            color: #ffd700;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 5px;
        }
        
        .tab-button.active {
            background: #ffd700;
            color: #111;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .preview-image {
            max-width: 100px;
            height: auto;
            margin: 10px 0;
        }
        
        .submission-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }
        
        .submission-item {
            padding: 10px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        .logout-button {
            position: absolute;
            top: 20px;
            right: 20px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script defer src="js/particles-config.js"></script>
</head>
<body>
    <div id="particles-js"></div>

    <header>
        <div class="header-left">
            <img src="assets/logo.png" alt="Yukon Wildcats Logo">
        </div>
        <nav class="header-right">
            <a href="index.html">Home</a>
            <a href="services.html">Services</a>
            <a href="snow.html">Snow Removal</a>
            <a href="tow.html">Towing</a>
            <a href="web-services.html">Web Services</a>
            <a href="community.html">Community</a>
            <a href="contact.html">Contact</a>
            <a href="documents.html">Documents</a>
        </nav>
    </header>

    <div class="admin-container">
        <!-- Login Form -->
        <div id="loginForm" class="card hover-glow admin-login">
            <h2>Admin Login</h2>
            <form class="admin-form">
                <label for="username">Username:</label>
                <input type="text" id="username" required>
                
                <label for="password">Password:</label>
                <input type="password" id="password" required>
                
                <button type="submit" class="cta-button">Login</button>
            </form>
        </div>

        <!-- Admin Panel (hidden by default) -->
        <div id="adminPanel" class="admin-panel">
            <button onclick="logout()" class="cta-button logout-button">Logout</button>
            <h2>Welcome, <span id="userRole">Admin</span></h2>
            
            <div class="admin-tabs">
                <button class="tab-button active" data-tab="announcements">Announcements</button>
                <button class="tab-button" data-tab="content">Content</button>
                <button class="tab-button" data-tab="team">Team</button>
                <button class="tab-button" data-tab="photos">Photos</button>
                <button class="tab-button" data-tab="submissions">Submissions</button>
                <button class="tab-button" data-tab="webquotes">Web Quotes</button>
            </div>

            <!-- Announcements Tab -->
            <div id="announcementsTab" class="tab-content active">
                <h3>Manage Site Announcement</h3>
                <form id="announcementForm" class="admin-form">
                    <label for="announcementText">Announcement Text:</label>
                    <input type="text" id="announcementText" required 
                           value="NOTICE: Currently only offering Web Development Services. Other services coming soon!">
                    
                    <label for="announcementEnabled">
                        <input type="checkbox" id="announcementEnabled" checked>
                        Show Announcement
                    </label>
                    
                    <button type="submit" class="cta-button">Update Announcement</button>
                </form>
            </div>

            <!-- Content Tab -->
            <div id="contentTab" class="tab-content active">
                <h3>Update Website Content</h3>
                <form id="contentForm" class="admin-form">
                    <label for="section">Select Section:</label>
                    <select id="section" required>
                        <option value="">Choose section...</option>
                        <option value="hero">Hero Section</option>
                        <option value="about">About Section</option>
                        <option value="services">Services Section</option>
                        <option value="community">Community Updates</option>
                    </select>

                    <label for="contentText">Content:</label>
                    <textarea id="contentText" rows="4" required></textarea>

                    <button type="submit" class="cta-button">Update Content</button>
                </form>
            </div>

            <!-- Team Tab -->
            <div id="teamTab" class="tab-content">
                <h3>Team Management</h3>
                <div class="grid-container">
                    <div class="card hover-glow">
                        <h4>Update Team Member</h4>
                        <form id="teamForm" class="admin-form">
                            <label for="memberSelect">Select Member:</label>
                            <select id="memberSelect" required>
                                <option value="lazarus">Lazarus Vanbibber</option>
                                <option value="micah">Micah Wolfe</option>
                                <option value="elias">Elias Wolfe</option>
                            </select>

                            <label for="memberTitle">Title:</label>
                            <input type="text" id="memberTitle" required>
                            
                            <label for="memberPhoto">Photo:</label>
                            <input type="file" id="memberPhoto" accept="image/*">
                            
                            <button type="submit" class="cta-button">Update Member</button>
                        </form>
                    </div>
                    <div id="teamPreview" class="card hover-glow">
                        <h4>Current Team</h4>
                        <!-- Team members will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Photos Tab -->
            <div id="photosTab" class="tab-content">
                <h3>Update Photos</h3>
                <div class="grid-container">
                    <div class="card hover-glow">
                        <h4>Service Icons</h4>
                        <form id="iconForm" class="admin-form">
                            <label for="iconSelect">Select Icon:</label>
                            <select id="iconSelect" required>
                                <option value="snow">Snow Removal</option>
                                <option value="tow">Towing</option>
                                <option value="excavator">Excavation</option>
                                <option value="dumptruck">Dump Truck</option>
                            </select>

                            <div id="currentIcon">
                                <!-- Current icon preview -->
                            </div>

                            <label for="newIcon">New Icon:</label>
                            <input type="file" id="newIcon" accept="image/*" required>
                            
                            <button type="submit" class="cta-button">Update Icon</button>
                        </form>
                    </div>
                    <div class="card hover-glow">
                        <h4>Company Logo</h4>
                        <form id="logoForm" class="admin-form">
                            <img src="assets/logo.png" alt="Current Logo" class="preview-image">
                            <label for="newLogo">New Logo:</label>
                            <input type="file" id="newLogo" accept="image/*" required>
                            <button type="submit" class="cta-button">Update Logo</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Submissions Tab -->
            <div id="submissionsTab" class="tab-content">
                <h3>Form Submissions</h3>
                <div id="submissionsList" class="submission-list">
                    <!-- Submissions will be loaded here -->
                </div>
            </div>

            <!-- Web Quotes Tab -->
            <div id="webquotesTab" class="tab-content">
                <h3>Web Development Quotes</h3>
                <div id="webQuotesList" class="submission-list">
                    <!-- Web quotes will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>Â© 2025 Yukon Wildcats Contracting | Whitehorse, Yukon</p>
    </footer>

    <script>
        // Use the production API on GitHub Pages. If you need to test locally,
        // change this to 'http://localhost:3000/api' temporarily.
        const API_URL = 'https://yukon-wildcats-api.onrender.com/api';
        let authToken = localStorage.getItem('yw_auth_token');
        let userRole = localStorage.getItem('yw_user_role');

        // DOM Elements
        const loginForm = document.querySelector('#loginForm');
        const adminPanel = document.querySelector('#adminPanel');
        const userRoleSpan = document.querySelector('#userRole');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const submissionsList = document.querySelector('#submissionsList');
        const contentForm = document.querySelector('#contentForm');
        const teamForm = document.querySelector('#teamForm');
        const iconForm = document.querySelector('#iconForm');
        const logoForm = document.querySelector('#logoForm');

        // Check authentication on load
        async function checkAuth() {
            if (!authToken) {
                showLoginForm();
                return;
            }

            try {
                const response = await fetch(`${API_URL}/submissions`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    showAdminPanel();
                    loadSubmissions();
                    loadTeamData();
                } else {
                    logout();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                logout();
            }
        }

        // Login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.querySelector('#username').value;
            const password = document.querySelector('#password').value;

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    userRole = data.role;
                    localStorage.setItem('yw_auth_token', authToken);
                    localStorage.setItem('yw_user_role', userRole);
                    showAdminPanel();
                    loadSubmissions();
                    loadTeamData();
                } else {
                    alert('Invalid credentials');
                }
            } catch (error) {
                console.error('Login failed:', error);
                alert('Login failed. Please try again.');
            }
        });

        // Tab switching
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                button.classList.add('active');
                document.querySelector(`#${button.dataset.tab}Tab`).classList.add('active');
            });
        });

        // Content form submission
        contentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const section = document.querySelector('#section').value;
            const content = document.querySelector('#contentText').value;

            try {
                const response = await fetch(`${API_URL}/content`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        location: section,
                        type: 'text',
                        content
                    })
                });

                if (response.ok) {
                    alert('Content updated successfully!');
                    contentForm.reset();
                } else {
                    alert('Failed to update content');
                }
            } catch (error) {
                console.error('Content update failed:', error);
                alert('Failed to update content');
            }
        });

        // Team form submission
        teamForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('member', document.querySelector('#memberSelect').value);
            formData.append('title', document.querySelector('#memberTitle').value);
            if (document.querySelector('#memberPhoto').files[0]) {
                formData.append('photo', document.querySelector('#memberPhoto').files[0]);
            }

            try {
                const response = await fetch(`${API_URL}/team`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    alert('Team member updated successfully!');
                    teamForm.reset();
                    
                    // Update team preview
                    const teamPreview = document.querySelector('#teamPreview');
                    const team = data.team || [];
                    teamPreview.innerHTML = team.map(member => `
                        <div class="team-member">
                            <img src="${member.photo || 'assets/default-profile.png'}" alt="${member.name}" class="preview-image">
                            <h4>${member.name}</h4>
                            <p>${member.title}</p>
                        </div>
                    `).join('');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to update team member');
                }
            } catch (error) {
                console.error('Team update failed:', error);
                alert(error.message || 'Failed to update team member. Please try again.');
            }
        });

        // Icon form submission
        iconForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('icon', document.querySelector('#iconSelect').value);
            formData.append('file', document.querySelector('#newIcon').files[0]);

            try {
                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                if (response.ok) {
                    alert('Icon updated successfully!');
                    iconForm.reset();
                    loadCurrentIcon();
                } else {
                    alert('Failed to update icon');
                }
            } catch (error) {
                console.error('Icon update failed:', error);
                alert('Failed to update icon');
            }
        });

        // Logo form submission
        logoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('file', document.querySelector('#newLogo').files[0]);

            try {
                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                if (response.ok) {
                    alert('Logo updated successfully!');
                    logoForm.reset();
                    document.querySelectorAll('img[src="assets/logo.png"]').forEach(img => {
                        img.src = 'assets/logo.png?' + new Date().getTime();
                    });
                } else {
                    alert('Failed to update logo');
                }
            } catch (error) {
                console.error('Logo update failed:', error);
                alert('Failed to update logo');
            }
        });

        // Load submissions
        async function loadSubmissions() {
            try {
                // Load regular submissions
                const response = await fetch(`${API_URL}/submissions`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const submissions = await response.json();
                    const regularSubmissions = submissions.filter(sub => sub.type !== 'web-development');
                    submissionsList.innerHTML = regularSubmissions.map(sub => `
                        <div class="submission-item">
                            <p><strong>Name:</strong> ${sub.name}</p>
                            <p><strong>Email:</strong> ${sub.email}</p>
                            <p><strong>Service:</strong> ${sub.service}</p>
                            <p><strong>Message:</strong> ${sub.message || ''}</p>
                            <p><strong>Date:</strong> ${sub.date}</p>
                        </div>
                    `).join('');

                    // Load web development quotes
                    const webQuotes = submissions.filter(sub => sub.type === 'web-development');
                    document.getElementById('webQuotesList').innerHTML = webQuotes.map(quote => `
                        <div class="submission-item">
                            <p><strong>Name:</strong> ${quote.name}</p>
                            <p><strong>Email:</strong> ${quote.email}</p>
                            <p><strong>Phone:</strong> ${quote.phone || 'Not provided'}</p>
                            <p><strong>Package:</strong> ${quote.package}</p>
                            <p><strong>Timeline:</strong> ${quote.timeline}</p>
                            <p><strong>Requirements:</strong> ${quote.requirements}</p>
                            <p><strong>Date:</strong> ${quote.date}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load submissions:', error);
            }
        }

        // Load team data
        async function loadTeamData() {
            try {
                const response = await fetch(`${API_URL}/team`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const team = await response.json();
                    document.querySelector('#teamPreview').innerHTML = team.map(member => `
                        <div class="team-member">
                            <img src="${member.photo}" alt="${member.name}" class="preview-image">
                            <h4>${member.name}</h4>
                            <p>${member.title}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load team data:', error);
            }
        }

        // Load current icon
        function loadCurrentIcon() {
            const iconSelect = document.querySelector('#iconSelect');
            const currentIcon = document.querySelector('#currentIcon');
            currentIcon.innerHTML = `
                <img src="assets/${iconSelect.value}_icon.png" alt="${iconSelect.options[iconSelect.selectedIndex].text}" class="preview-image">
            `;
        }

        // Icon select change handler
        document.querySelector('#iconSelect').addEventListener('change', loadCurrentIcon);

        // Helper functions
        function showLoginForm() {
            loginForm.style.display = 'block';
            adminPanel.style.display = 'none';
        }

        function showAdminPanel() {
            loginForm.style.display = 'none';
            adminPanel.style.display = 'block';
            userRoleSpan.textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
        }

        function logout() {
            localStorage.removeItem('yw_auth_token');
            localStorage.removeItem('yw_user_role');
            authToken = null;
            userRole = null;
            showLoginForm();
        }

        // Handle announcement form
        const announcementForm = document.querySelector('#announcementForm');
        if (announcementForm) {
            // Load current announcement settings
            const currentAnnouncement = localStorage.getItem('yw_announcement');
            if (currentAnnouncement) {
                announcementForm.announcementText.value = currentAnnouncement;
            }
            
            announcementForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = announcementForm.announcementText.value;
                const isEnabled = announcementForm.announcementEnabled.checked;
                
                if (isEnabled) {
                    localStorage.setItem('yw_announcement', text);
                    localStorage.removeItem('yw_announcement_dismissed');
                } else {
                    localStorage.removeItem('yw_announcement');
                    localStorage.removeItem('yw_announcement_dismissed');
                }
                
                alert('Announcement settings updated! Refresh any open pages to see the changes.');
            });
        }

        // Initialize
        checkAuth();
        if (document.querySelector('#iconSelect')) {
            loadCurrentIcon();
        }
    </script>
</body>
</html>